/*! WP Simple Pay Pro 3 - 3.1.18
 * https://wpsimplepay.com/
 * Copyright (c) Moonstone Media Group 2018
 * Licensed GPLv2+ */

var simpayAppPro={};!function(n){"use strict";var a;(simpayAppPro={init:function(){(a=n(document.body)).on("simpayFormVarsInitialized",function(n,a,t){simpayAppPro.setupValidation(a,t)}),a.on("simpayBindEventsAndTriggers",simpayAppPro.processForm),a.on("simpayFinalizeAmount",simpayAppPro.setFinalAmount)},processForm:function(n,a,t){(t=simpayApp.spFormData[t.formId]).taxAmount=simpayAppPro.calculateTaxAmount(t.amount,t.taxPercent),t.isSubscription&&"single"===t.subscriptionType&&(t.planAmount=t.amount),t.couponCode="",simpayAppPro.initDateField(a,t),simpayAppPro.updateTotalAmount(a,t),a.find(".simpay-custom-amount-input").on("keyup.simpayCustomAmountInput change.simpayCustomAmountInput",function(n){simpayAppPro.processCustomAmountInput(a,t),simpayAppPro.updateTotalAmount(a,t)}),a.find(".simpay-apply-coupon").on("click.simpayApplyCoupon",function(n){n.preventDefault(),simpayAppPro.applyCoupon(a,t),simpayAppPro.updateTotalAmount(a,t)}),a.find(".simpay-remove-coupon").on("click.simpayRemoveCoupon",function(n){n.preventDefault(),simpayAppPro.removeCoupon(a,t)}),a.find(".simpay-amount-dropdown, .simpay-amount-radio").on("change.simpayAmountSelect",function(n){simpayAppPro.updateAmountSelect(a,t)}),a.find(".simpay-quantity-dropdown, .simpay-quantity-radio").on("change.simpayQuantitySelect",function(){simpayAppPro.updateQuantitySelect(a,t)}),a.find(".simpay-quantity-input").on("keyup.simpayNumberQuantity, change.simpayNumberQuantity, input.simpayNumberQuantity",function(n){simpayAppPro.updateQuantitySelect(a,t),simpayAppPro.updateTotalAmount(a,t)}),a.find(".simpay-multi-sub, .simpay-plan-wrapper select").on("change.simpayMultiPlan",function(n){simpayAppPro.changeMultiSubAmount(a,t)}),a.find(".simpay-custom-amount-input").on("focus.simpayCustomAmountFocus",function(n){simpayAppPro.handleCustomAmountFocus(a,t)}),a.on("simpayCouponApplied",function(n){simpayAppPro.updateTotalAmount(a,t)}),a.on("simpayCouponRemoved",function(n){simpayAppPro.updateTotalAmount(a,t)}),a.on("simpayDropdownAmountChange",function(n){""===t.couponCode.trim()&&simpayAppPro.updateTotalAmount(a,t)}),a.on("simpayRadioAmountChange",function(n){""===t.couponCode.trim()&&simpayAppPro.updateTotalAmount(a,t)}),a.on("simpayDropdownQuantityChange",function(n){""===t.couponCode.trim()&&simpayAppPro.updateTotalAmount(a,t)}),a.on("simpayRadioQuantityChange",function(n){""===t.couponCode.trim()&&simpayAppPro.updateTotalAmount(a,t)}),a.on("simpayNumberQuantityChange",function(n){""===t.couponCode.trim()&&simpayAppPro.updateTotalAmount(a,t)}),a.on("simpayMultiPlanChanged",function(n){""===t.couponCode.trim()&&simpayAppPro.updateTotalAmount(a,t)}),a.on("simpayBeforeStripePayment",function(n,a,t){simpayAppPro.submitPayment(a,t)}),a.find(".simpay-custom-amount-input").trigger("change.simpayCustomAmountInput"),a.find(".simpay-amount-dropdown, .simpay-amount-radio").trigger("change.simpayAmountSelect"),a.find(".simpay-quantity-dropdown, .simpay-quantity-radio").trigger("change.simpayQuantitySelect"),a.find(".simpay-multi-sub:checked, .simpay-plan-wrapper select:selected").trigger("change.simpayMultiPlan"),a.find(".simpay-quantity-input").trigger("input.simpayNumberQuantity")},handleCustomAmountFocus:function(n,a){var t=n.find(".simpay-custom-plan-option"),o=n.find(".simpay-custom-amount-input");t.is("input")?t.prop("checked",!0):t.is("option")&&t.prop("selected",!0),a.useCustomPlan=!0,n.find(".simpay-has-custom-plan").val("true"),a.customPlanAmount=simpayApp.convertToCents(o.val())},submitPayment:function(n,a){a.isTrial&&0===a.finalAmount?a.stripeParams.panelLabel=a.freeTrialButtonText:a.stripeParams.panelLabel=a.oldPanelLabel},setupValidation:function(t){var o=t.data("simpay-form-id");n.validator.addMethod("minCheck",function(n,a,t){var o=spShared.unformatCurrency(n),p=spShared.unformatCurrency(t);return this.optional(a)||parseFloat(o)>=parseFloat(p)||""===o}),t.validate({errorPlacement:function(n,a){var o=t.find(a).data("error");o?t.find(o).append(n):n.insertAfter(t.find(a))},rules:{simpay_custom_amount:{required:!0,minCheck:simpayApp.formatMoney(spShared.unformatCurrency(simplePayForms[o].form.integers.minAmount))},simpay_subscription_custom_amount:{required:!0,minCheck:simpayApp.formatMoney(spShared.unformatCurrency(simplePayForms[o].form.integers.subMinAmount))}},messages:{simpay_custom_amount:simplePayForms[o].form.i18n.minCustomAmountError,simpay_subscription_custom_amount:simplePayForms[o].form.i18n.subMinCustomAmountError}}),a.trigger("simpayFormValidationInitialized",[t])},initDateField:function(n,a){n.find(".simpay-date-input").datepicker(),n.find(".simpay-date-input").datepicker("option","dateFormat",a.dateFormat)},processCustomAmountInput:function(n,a){var t=n.find(".simpay-custom-amount-input").val();a.isSubscription?(a.customAmount=simpayApp.convertToCents(spShared.unformatCurrency(""!==t?t:simpayApp.convertFromCents(a.subMinAmount))),a.customPlanAmount=a.customAmount,a.planAmount=a.customAmount):a.customAmount=simpayApp.convertToCents(spShared.unformatCurrency(""!==t?t:simpayApp.convertFromCents(a.minAmount))),simpayAppPro.applyCoupon(n,a)},setFinalAmount:function(n,a,t){var o=t.amount;"undefined"!==t.customAmount&&t.customAmount>0&&(o=spGeneral.booleans.isZeroDecimal?parseInt(t.customAmount):parseFloat(t.customAmount)),void 0!==t.isSubscription&&t.isSubscription&&(o="single"===t.subscriptionType?void 0!==t.customPlanAmount?t.customPlanAmount:t.amount:void 0!==t.useCustomPlan&&t.useCustomPlan?t.customPlanAmount:t.planAmount,t.isTrial&&(o=0),void 0!==t.setupFee&&(o+=t.setupFee),void 0!==t.planSetupFee&&(o+=t.planSetupFee)),void 0!==t.quantity&&(o*=t.quantity),void 0!==t.discount&&(o-=t.discount),void 0===t.isSubscription||t.isSubscription||(t.feePercent>0&&(o+=o*(t.feePercent/100)),t.feeAmount>0&&(o+=t.feeAmount)),t.taxPercent>0&&(t.taxAmount=simpayAppPro.calculateTaxAmount(o,t.taxPercent),o+=Math.round(t.taxAmount),a.find(".simpay-tax-amount").val(t.taxAmount)),t.finalAmount=o},applyCoupon:function(a,t){var o=a.find(".simpay-coupon-field"),p=null,i=a.find(".simpay-coupon-message"),u=a.find(".simpay-coupon-loading"),e=a.find(".simpay-remove-coupon"),m=a.find(".simpay-coupon"),s="",r="",d=t.amount,y=0;if(o.val())s=o.val();else{if(!t.couponCode)return;s=t.couponCode}t.isSubscription?(void 0!==t.setupFee?y=t.setupFee:void 0!==t.planSetupFee&&(y=t.planSetupFee),d=t.useCustomPlan?t.customPlanAmount+y:t.planAmount+y):"undefined"!==t.customAmount&&t.customAmount>0&&(d=t.customAmount),void 0!==t.quantity&&(d*=t.quantity),p={action:"simpay_get_coupon",coupon:s,amount:d,couponNonce:a.find("#simpay_coupon_nonce").val()},i.text(""),e.hide(),o.val(""),u.show(),n.ajax({url:spGeneral.strings.ajaxurl,method:"POST",data:p,dataType:"json",success:function(o){t.couponCode=s,t.discount=o.discount,r=o.coupon.code+": ","percent"===o.coupon.type?r+=o.coupon.amountOff+spGeneral.i18n.couponPercentOffText:"amount"===o.coupon.type&&(r+=simpayApp.formatMoney(simpayApp.convertToCents(o.coupon.amountOff))+" "+spGeneral.i18n.couponAmountOffText),n(".coupon-details").remove(),i.append(r),n("<input />",{name:"simpay_coupon_details",type:"hidden",value:r,class:"simpay-coupon-details"}).appendTo(i),e.show(),m.val(s),u.hide(),a.trigger("simpayCouponApplied")},error:function(a){var t="";spShared.debugLog("Coupon error",a.responseText),a.responseText&&(t=a.responseText),i.append(n("<p />").addClass("simpay-field-error").text(t)),u.hide()}})},removeCoupon:function(n,a){n.find(".simpay-coupon-loading").hide(),n.find(".simpay-remove-coupon").hide(),n.find(".simpay-coupon-message").text(""),n.find(".simpay-coupon").val(""),a.couponCode="",a.discount=0,n.trigger("simpayCouponRemoved")},updateAmountSelect:function(n,a){n.find(".simpay-amount-dropdown").length?(a.amount=n.find(".simpay-amount-dropdown").find("option:selected").data("amount"),n.trigger("simpayDropdownAmountChange")):n.find(".simpay-amount-radio")&&(a.amount=n.find(".simpay-amount-radio").find('input[type="radio"]:checked').data("amount"),n.trigger("simpayRadioAmountChange")),simpayAppPro.applyCoupon(n,a)},updateQuantitySelect:function(n,a){a.quantity=1,n.find(".simpay-quantity-dropdown").length?(a.quantity=n.find(".simpay-quantity-dropdown").find("option:selected").data("quantity"),n.trigger("simpayDropdownQuantityChange")):n.find(".simpay-quantity-radio").length?(a.quantity=n.find(".simpay-quantity-radio").find('input[type="radio"]:checked').data("quantity"),n.trigger("simpayRadioQuantityChange")):n.find(".simpay-quantity-input").length&&(a.quantity=parseInt(n.find(".simpay-quantity-input").val()),n.trigger("simpayNumberQuantityChange")),a.quantity<1&&(a.quantity=1),n.find(".simpay-quantity").val(a.quantity),simpayAppPro.applyCoupon(n,a)},updateTotalAmount:function(n,a){simpayAppPro.setFinalAmount(null,n,a),n.find(".simpay-total-amount-value").text(simpayApp.formatMoney(a.finalAmount)),simpayAppPro.updateRecurringAmountLabel(n,a),simpayAppPro.updateTaxAmountLabel(n,a)},updateRecurringAmountLabel:function(n,a){var t=a.planAmount*a.quantity,o=t+simpayAppPro.calculateTaxAmount(t,a.taxPercent);a.planIntervalCount>1?n.find(".simpay-total-amount-recurring-value").text(simpayApp.formatMoney(o)+" every "+a.planIntervalCount+" "+a.planInterval+"s"):n.find(".simpay-total-amount-recurring-value").text(simpayApp.formatMoney(o)+"/"+a.planInterval)},updateTaxAmountLabel:function(n,a){n.find(".simpay-tax-amount-value").text(simpayApp.formatMoney(a.taxAmount))},calculateTaxAmount:function(n,a){return n*(a/100)},changeMultiSubAmount:function(n,a){var t="",o=n.find(".simpay-custom-amount-input"),p=n.find(".simpay-plan-wrapper").find(".simpay-multi-sub"),i=0,u="",e=0,m="",s=1,r=!1,d=0;p.first().is("option")?(u=(t=p.filter(":selected")).data("plan-id"),i=t.data("plan-setup-fee"),e=t.data("plan-amount"),m=t.data("plan-interval"),s=t.data("plan-interval-count"),r=void 0!==t.data("plan-trial"),d=t.data("plan-max-charges"),"simpay_custom_plan"===t.val()?(a.useCustomPlan=!0,e=simpayApp.convertToCents(o.val())):a.useCustomPlan=!1,r&&(a.amount=0)):(u=(t=p.filter(":checked")).data("plan-id"),i=t.data("plan-setup-fee"),e=t.data("plan-amount"),m=t.data("plan-interval"),s=t.data("plan-interval-count"),r=void 0!==t.data("plan-trial"),d=t.data("plan-max-charges"),"simpay_custom_plan"===t.val()?(a.useCustomPlan=!0,e=simpayApp.convertToCents(o.val())):a.useCustomPlan=!1,r&&(a.amount=0)),a.planId=u,a.planSetupFee=i,a.planAmount=e,a.planInterval=m,a.planIntervalCount=s,a.isTrial=r,t.hasClass("simpay-custom-plan-option")?n.find(".simpay-has-custom-plan").val("true"):n.find(".simpay-has-custom-plan").val(""),o.val(simpayApp.convertFromCents(e)),a.useCustomPlan&&o.focus(),n.find(".simpay-multi-plan-id").val(u),n.find(".simpay-multi-plan-setup-fee").val(i),n.find(".simpay-max-charges").val(d),n.trigger("simpayMultiPlanChanged"),simpayAppPro.applyCoupon(n,a)}}).init()}(jQuery);